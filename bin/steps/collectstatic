#! /bin/bash
#
# collectstatic
# Copyright (C) 2016 dhilipsiva <dhilipsiva@gmail.com>
#
# Distributed under terms of the MIT license.
#


# Runtime arguments:
#   - $DISABLE_COLLECTSTATIC: disables this functionality.

source $BIN_DIR/utils

# Location of 'manage.py', if it exists.
MANAGE_FILE=$(find . -maxdepth 3 -type f -name 'manage.py' -printf '%d\t%P\n' | sort -nk1 | cut -f2 | head -1)
MANAGE_FILE=${MANAGE_FILE:-fakepath}

set +e

puts-cmd "python $MANAGE_FILE collectstatic --noinput"

# Run collectstatic, cleanup some of the noisy output.
python $MANAGE_FILE collectstatic --noinput --traceback 2>&1 | sed '/^Post-processed/d;/^Copying/d;/^$/d' | indent
COLLECTSTATIC_STATUS="${PIPESTATUS[0]}"

set -e

# Display a warning if collectstatic failed.
[ $COLLECTSTATIC_STATUS -ne 0 ] && {

    # Additionally, dump out the environment, if debug mode is on.
    echo
    echo "****** Collectstatic environment variables:"
    echo
    env | indent

    # Abort the build.
    exit 1
}
